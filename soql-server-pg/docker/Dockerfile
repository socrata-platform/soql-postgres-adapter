FROM socrata/java8-focal

EXPOSE 6090
EXPOSE 6091/udp
ENV JMX_PORT 6099

RUN apt-get -y update && apt-get -y install jq

ENV SERVER_ROOT /srv/soql-server-pg
ENV SERVER_ARTIFACT soql-server-pg-assembly.jar
ENV SERVER_CONFIG soql-server-pg.conf

# defaults
ENV ENABLE_GRAPHITE false
ENV GRAPHITE_HOST 0.0.0.0
ENV GRAPHITE_PORT 0
ENV JAVA_XMX 512m
ENV LOG_METRICS false
ENV LOG_LEVEL INFO
ENV PG_SECONDARY_DB_NAME falth
ENV PG_SECONDARY_DB_PORT 5432
ENV PG_SECONDARY_DB_USER soda_query
ENV PG_SECONDARY_MIGRATE_DB_USER soda_store
ENV PG_SECONDARY_INSTANCE pg
ENV PG_SECONDARY_WORK_MEM 256MB
ENV PG_SECONDARY_CLIENT_MSG_LEVEL error
ENV PG_SECONDARY_MAX_POOL_SIZE 40
ENV PG_SECONDARY_MAX_CACHED_RESULTS 10000
ENV PG_SECONDARY_MAX_CACHED_RESULT_SIZE 10240
ENV PG_SECONDARY_MAX_REQUEST_THREADS 100
ENV PG_SECONDARY_MAX_REQUEST_QUEUE_LENGTH 500
ENV JAVA_MAX_METASPACE 64m
ENV JAVA_OOM_BEHAVIOR -XX:+ExitOnOutOfMemoryError
ENV JAVA_GC_LOG_BEHAVIOR="-Xloggc:/tmp/gc.log -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintTenuringDistribution -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=50M -XX:+TraceClassLoading -XX:+PrintGCCause -XX:+TraceClassUnloading"
ENV MAX_CONCURRENT_REQUESTS_PER_DATASET 15

WORKDIR $SERVER_ROOT

COPY ship.d /etc/ship.d
COPY ${SERVER_CONFIG}.j2 $SERVER_ROOT/
COPY $SERVER_ARTIFACT $SERVER_ROOT/

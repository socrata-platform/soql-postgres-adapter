<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    <changeSet author="Marc Slemko" id="20200210-add-median-function" runOnChange="true">
        <!-- MD5SUM 3:b3870faef68cbd3d5ef9309873f880c9 -->
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">select (regexp_matches(version(), 'PostgreSQL ([0-9\.]+) on','g'))[1]::numeric &lt; 14</sqlCheck>
        </preConditions>

        <sql splitStatements="false">
            -- This is the second function on https://wiki.postgresql.org/wiki/Aggregate_Median as of 2020/02/10, with
            -- the following modifications:
            --
            -- * Returns anyelement instead of hardcoding float8 to avoid unnecessary type conversions.  In the original
            --   you could end up returning a value that wasn't in the dataset especially if the source data has already
            --   been "enhanced" by misconceived floating type conversions outside the platform.
            --
            CREATE OR REPLACE FUNCTION _final_median_ulib_agg(anyarray) RETURNS anyelement AS $$
              WITH q AS
              (
                 SELECT val
                 FROM unnest($1) val
                 WHERE VAL IS NOT NULL
                 ORDER BY 1
              ),
              cnt AS
              (
                SELECT COUNT(*) AS c FROM q
              )
              SELECT AVG(val)
              FROM
              (
                SELECT val FROM q
                LIMIT  2 - MOD((SELECT c FROM cnt), 2)
                OFFSET GREATEST(CEIL((SELECT c FROM cnt) / 2.0) - 1,0)
              ) q2;
            $$ LANGUAGE SQL IMMUTABLE;

            CREATE OR REPLACE AGGREGATE median_ulib_agg(anyelement) (
              SFUNC=array_append,
              STYPE=anyarray,
              FINALFUNC=_final_median_ulib_agg,
              INITCOND='{}'
            );
        </sql>
        <rollback>
            <sql>
                DROP AGGREGATE IF EXISTS median_ulib_agg(anyelement);
                DROP FUNCTION IF EXISTS _final_median_ulib_agg(anyarray);
            </sql>
        </rollback>
    </changeSet>

    <changeSet author="Chi" id="20200210-add-median-function-pg14+" runOnChange="true">

        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">select (regexp_matches(version(), 'PostgreSQL ([0-9\.]+) on','g'))[1]::numeric >= 14</sqlCheck>
        </preConditions>

        <sql splitStatements="false">
            -- This is the second function on https://wiki.postgresql.org/wiki/Aggregate_Median as of 2020/02/10, with
            -- the following modifications:
            --
            -- * Returns anyelement instead of hardcoding float8 to avoid unnecessary type conversions.  In the original
            --   you could end up returning a value that wasn't in the dataset especially if the source data has already
            --   been "enhanced" by misconceived floating type conversions outside the platform.
            --
            CREATE OR REPLACE FUNCTION _final_median_ulib_agg(anycompatiblearray) RETURNS anycompatible AS $$
              WITH q AS
              (
                SELECT val
                  FROM unnest($1) val
                 WHERE VAL IS NOT NULL
                 ORDER BY 1
              ),
              cnt AS
              (
                SELECT COUNT(*) AS c FROM q
              )
              SELECT AVG(val)
                FROM
                (
                  SELECT val FROM q
                   LIMIT  2 - MOD((SELECT c FROM cnt), 2)
                  OFFSET GREATEST(CEIL((SELECT c FROM cnt) / 2.0) - 1,0)
                ) q2;
            $$ LANGUAGE SQL IMMUTABLE;

            CREATE OR REPLACE AGGREGATE median_ulib_agg(anycompatible) (
              SFUNC=array_append,
              STYPE=anycompatiblearray,
              FINALFUNC=_final_median_ulib_agg,
              INITCOND='{}'
            );
        </sql>
        <rollback>
            <sql>
                DROP AGGREGATE IF EXISTS median_ulib_agg(anycompatible);
                DROP FUNCTION IF EXISTS _final_median_ulib_agg(anycompatiblearray);
            </sql>
        </rollback>
    </changeSet>
</databaseChangeLog>
